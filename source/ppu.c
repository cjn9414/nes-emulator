#include "ppu.h"
#define KB 1024

typedef struct {
  unsigned char tbl[0x20][0x1E];  // 32x30
  unsigned char attr[0x8][0x8];
} NameTable;

//PatternTable pTable0;
//PatternTable pTable1;

unsigned char pTable0[0x1000];
unsigned char pTable1[0x1000];

NameTable nTable0;
NameTable nTable1;
NameTable nTable2;
NameTable nTable3;

unsigned char imagePalette[0x10];
unsigned char spritePalette[0x10];

struct color palette[48] = {
  { 0x00, {0x75, 0x75, 0x75} },
  { 0x01, {0x27, 0x1B, 0x8F} },
  { 0x02, {0x00, 0x00, 0xAB} },
  { 0x03, {0x47, 0x00, 0x9F} },
  { 0x04, {0x8F, 0x00, 0x77} },
  { 0x05, {0xAB, 0x00, 0x13} },
  { 0x06, {0xA7, 0x00, 0x00} },
  { 0x07, {0x7F, 0x0B, 0x00} },
  { 0x08, {0x43, 0x2F, 0x00} },
  { 0x09, {0x00, 0x47, 0x00} },
  { 0x0A, {0x00, 0x51, 0x00} },
  { 0x0B, {0x00, 0x3F, 0x17} },
  { 0x0C, {0x1B, 0x3F, 0x5F} },
  { 0x0D, {0x00, 0x00, 0x00} },
  { 0x0E, {0x00, 0x00, 0x00} },
  { 0x0F, {0x00, 0x00, 0x00} },
  { 0x10, {0xBC, 0xBC, 0xBC} },
  { 0x11, {0x00, 0x73, 0xEF} },
  { 0x12, {0x23, 0x3B, 0xEF} },
  { 0x13, {0x83, 0x00, 0xF3} },
  { 0x14, {0xBF, 0x00, 0xBF} },
  { 0x15, {0xE7, 0x00, 0x5B} },
  { 0x16, {0xDB, 0x2B, 0x00} },
  { 0x17, {0xCB, 0x4F, 0x0F} },
  { 0x18, {0x8B, 0x73, 0x00} },
  { 0x19, {0x00, 0x97, 0x00} },
  { 0x1A, {0x00, 0xAB, 0x00} },
  { 0x1B, {0x00, 0x93, 0x3B} },
  { 0x1C, {0x00, 0x83, 0x8B} },
  { 0x1D, {0x00, 0x00, 0x00} },
  { 0x1E, {0x00, 0x00, 0x00} },
  { 0x1F, {0x00, 0x00, 0x00} },
  { 0x20, {0xFF, 0xFF, 0xFF} },
  { 0x21, {0x3F, 0xBF, 0xFF} },
  { 0x22, {0x5F, 0x97, 0xFF} },
  { 0x23, {0xA7, 0x8B, 0xFD} },
  { 0x24, {0xF7, 0x7B, 0xFF} },
  { 0x25, {0xFF, 0x77, 0xB7} },
  { 0x26, {0xFF, 0x77, 0x63} },
  { 0x27, {0xFF, 0x9B, 0x3B} },
  { 0x28, {0xF3, 0xBF, 0x3F} },
  { 0x29, {0x83, 0xD3, 0x13} },
  { 0x2A, {0x4F, 0xDF, 0x4B} },
  { 0x2B, {0x58, 0xF8, 0x98} },
  { 0x2C, {0x00, 0xEB, 0xDB} },
  { 0x2D, {0x00, 0x00, 0x00} },
  { 0x2E, {0x00, 0x00, 0x00} },
  { 0x2F, {0x00, 0x00, 0x00} },
  { 0x30, {0xFF, 0xFF, 0xFF} },
  { 0x31, {0xAB, 0xE7, 0xFF} },
  { 0x32, {0xC7, 0xD7, 0xFF} },
  { 0x33, {0xD7, 0xCB, 0xFF} },
  { 0x34, {0xFF, 0xC7, 0xFF} },
  { 0x35, {0xFF, 0xC7, 0xDB} },
  { 0x36, {0xFF, 0xBF, 0xB3} },
  { 0x37, {0xFF, 0xDB, 0xAB} },
  { 0x38, {0xFF, 0xE7, 0xA3} },
  { 0x39, {0xE3, 0xFF, 0xA3} },
  { 0x3A, {0xAB, 0xF3, 0xBF} },
  { 0x3B, {0xB3, 0xFF, 0xCF} },
  { 0x3C, {0x9F, 0xFF, 0xF3} },
  { 0x3D, {0x00, 0x00, 0x00} },
  { 0x3E, {0x00, 0x00, 0x00} },
  { 0x3F, {0x00, 0x00, 0x00} },
};

void loadPPU (unsigned char * graphics) {
  memcpy(graphics, &pTable0, 4*KB);
  graphics += 4*KB;
  memcpy(graphics, &pTable1, 4*KB);
  graphics += 4*KB;
  memcpy(graphics, &nTable0, KB);
  graphics += KB;
  memcpy(graphics, &nTable1, KB);
  graphics += KB;
  memcpy(graphics, &nTable2, KB);
  graphics += KB;
  memcpy(graphics, &nTable3, KB);
  graphics += KB;
  memcpy(graphics, imagePalette, sizeof(unsigned char)*0x10);
  graphics += sizeof(unsigned char)*0x10;
  memcpy(graphics, spritePalette, sizeof(unsigned char)*0x10);
  graphics += sizeof(unsigned char)*0x10;
}

unsigned char readPictureByte(unsigned short addr) {
  addr %= 0x4000;
  
  if (addr >= 0x3000 && addr < 0x3F00) addr -= 0x1000;
  if (addr >= 0x3F20 && addr < 0x4000) {
    addr = addr%0x0020 + 0x3F00;
  }

  //if (addr < 0x1000) {
    //return pTable0.tiles[addr];
  //} 
  
  //else if (addr < 0x2000) {
    //return pTable1.tiles[addr - 0x1000];
  //} 
  
  else if (addr < 0x23C0) {
    return nTable0.tbl[addr - 0x2000];
  }

  else if (addr < 0x2400) {
    return nTable0.attr[addr - 0x23C0];
  }

  else if (addr < 0x27C0) {
    return nTable1.tbl[addr - 0x2400];
  }

  else if (addr < 0x2800) { 
    return nTable1.attr[addr - 0x27C0];
  }

  else if (addr < 0x2BC0) { 
    return nTable2.tbl[addr - 0x2800];
  }
    
  else if (addr < 0x2C00) { 
    return nTable2.attr[addr - 0x2BC0];
  }

  else if (addr < 0x2FC0) { 
    return nTable3.tbl[addr - 0x2C00];
  }

  else {
    return nTable3.attr[addr - 0x2FC0];
  }
}


